# Kafka

## Архитектура

- **Партиционирование** необходимо для горизонтального масштабирования(чтобы несколько инстансов одно и того же приложения могли читать из одного топика одновременно, тем самым снижая временные и ресурсные издержки).

  *<u>Создание топика с партициями через sh скрипт:</u>*

  `./kafka-topics.sh --create --partitions 12 --topic test`

  **Если топик не был создан, но продюссеры начинают писать в него сообщениея, то kafka автоматически создаст топик с 1 партицией**.

  С каждой партицией связан **только один консьюмер**.

  Рекомендуется делать **4-5(в идеале 8) партиции на консьюмера**(можно делать и больше, но партиции в kafka тяжелая структура, что нужно учитывать). Например, у топика event будет 2 консьюмера, значит нужно сделать 8-10 партиций для топика event, в таком случае при масштабировании уже подключенных консьюмеров и при подключении новых сервисов, будет запас по количеству партиций.

  Топиков не существует на физическом уровне - это лишь логическое разделение сообщений по темам, каждый топки объединяет набор партиций.

  Если партиций больше, чем консьюмеров, то "лишние" консьюмеры распределяются между существующими консьюмерами

- Порядок сообщений сохраняется в рамках партиции, но не в рамках топика.

  С помощью ключа сообщения можно гарантировать последовательную доставку сообщений в одну и ту же партицию и последовательное чтение соответствтенно

- Kafka поддерживает репликацию - копирование данных из одного брокера на другие. Можно самостоятельно настривать на сколько брокеров реплицировать партицию. При записи данных в партицию, при включенной репликации для топика, данные будут копироваться на дрегие брокеры kafka. Тем самым, обеспечивая возможность заменять вышедший из строя брокер. Репликация = бэкап

  <u>*Создание топика с репликацией через sh скрипт:*</u>

  `./kafka-topics.sh --create --partitions 12 --replication-factor 3 --topic test`

  При репликации, у каждой партиции есть свой лидер(брокер) и есть фолловеры(брокеры), при записи в топик, первым делом сообщение пишется в лидера, затем в фолловеров(лидер сам реплицирует данные). Чтение идет из лидера. Реплики используются, если лидер умер

  Рекомендуется использовать 3-5 реплики на каждый топик

- Скалирование - увеличение/уменьшение ресурсов кластера(брокеров или партиций). **При скалировании может меняться поярдок сообщений**(поэтому не рекомендует я проводить скалирование). Это происходит из-за того что партиция в которое упадет сообщение определяется остатком по делению(Кажется, что можно пофиксить с помощью ключа сообщения)