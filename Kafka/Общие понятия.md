# Kafka

## Основные понятия

- **Брокер Kafka** - сервер, принимающий, хранящий и отправляющий сообщения. Является частью кластера Kafka.

- Часто Kafka используется совместно с Zookeeper(до версии 3.0.0, где был введен KRaft). **Zookeeper** - централизованная служба, отвечающая за хранение конфигурационной информации и распредленную синхронизацию групповых сервисов(по сути бд). Kafka хранит там данные о конфигурации. Zookeeper так же масштабируется и обеспечивает отказоустойчивость.

- **Produces** - сервис, пишущий в Kafka.

- **Consumer** - сервис, читающий из kafka, консьюмеры могут обхединяться в группы.

- Один сервис может объединять в себе и отправку сообщений и чтение сообщений - **сквозное продюссирование**

- **Топик** - категория/поток, в который записываются сообщения. Топики используются для группировки сообщений. Топик может иметь несколько издателей и подписчиков. Чаще всего в топик приходят одинаковые сообщения, имеющие схожую структуру(например, топик для заказов, анкет и тд)

- **Партиция** - раздел топика. Каждый топик делится на партиции(по стандарту - 1 партиция в каждом топике). При отправке сообщения в топик, kafka сама решает, в какую партицию положить это сообщение, но гарантируется, что сообщения с одинаковым ключом попадут в  одну и ту же партицию. **В рамках одной партиции** гарантируется соблюдение последовательности сообщений. 

  Каждый консьюмер читает свою партицию, что гарантирует, при горизонтальном масштабировании, что одно сообщение протиает только один инстанс приложения.

- **Сообщение** в kafka состоит из 3 полей:

  - Ключ
  - Значение(произвольная последовательность байт)
  - Таймстамп(ставится kafka)

- **CAP теорема** - представляет треуголнить с вершинами: 

  - Консистентность - при чтении данных, есть уверенность, что данные придут в том же виде, в котором они были сохранены и в котором их ожидает увидеть система(есть набор правил, обеспечивающих целостность данных и система-хранитель их выполняет). То же самое относится к порядку сообщений.
  - Доступность - каждый работающий узел всегда успешно выполняет запросы
  - Сетевые отказы - Система продолжает рабортать, даже если связь между узлами потеряна.

  По CAP теореме можно выбрать только 2 свойства для распределенной системы из 3.

  Kafka в парадигме теоремы ложится между достпуностью и сетевыми отказами. Доступность - kafka обеспечивает общение между консьюмером и продюссером, даже при сбое отдельных брокеров. Сетевые отказы - после потери соединения, данные не потеряются и их можно будет прочитать после восстановления связи. По поводу консистентности - при сбое может быть нарушена синхронизация между брокерами, в таком случае реплики не смогут синхронизироватсья и возможна потеря консистентности.









