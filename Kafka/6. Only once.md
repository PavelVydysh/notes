# Kafka

## Подходы к работе с сообщениями

### Возможные проблемы

На стороне продюсера:

- Продюсеры пишут в брокер, брокер отсылает только один ack пакет в ответ.
Возможно дублирование сообщений, при условии, что на консьюмере стоит переотправка сообщения, 
пока не будет подтверждения о получении брокером.

- Продюсеры пишут в брокер, брокер считал сообщения и прилег. \
Под капотом у кафки есть кусок памяти, где накапливаются сообщения, у нее есть дисковое пространство, в которое она сливает сообщения
из памяти с определенной периодичностью. Есть так же два хелпера на чтение, первый держит в памяти кусок данных от минимального оффсета,
который есть у любого консьюмера кафки до конца лога(по максимуму по ограничению памяти).
Кафка может прилечь при записи в память, при слитии данных на диск и до получения сообщений.

- Продюсеры отправили сообщение и канал связи отвалился во время отправки сообщения(обрыв соединения).
В таком случае сообщение может быть потеряно.

На стороне консьюмера:

- Консьюмер группы считали сообщения, но коммит отправила только одна группа, хотя сообщение прочитано всеми успешно.
В таком случае, сообщения будут перечитаны консьюмерами, так как кафка не сохранит смещение для них.
Сообщение может быть прочитано несколько раз.

Возможно такое, что сообщения уйдут или прочитаются не в нужном порядке(часто возникает, 
если `max.in.flight.requests.per.connection` > 1)

### Возможные решения:

- acks > 0

- Заставить кафку чаще сливать сообщения на диск(установить `log.flush.interval.messages` ниже)

- Увеличить репликацию на топик

#### At least once

Доставка хотя бы одного сообщения. В таком случае система должна уметь избавляться от дубликатов.

- acks > 0 и переотправлять сообщения при ошибке

- **Помогает, когда отказало соединение клиента**

- Не поможет, если бркоер упал после сохранения сообщения и перед отправкой ack

#### At most once

Доставка не более одного сообщения.

- Не отсылать сообщение второй раз, если получили ошибку(но можно поставить ретрай на стороне продюсера).

- Можно потерять сообщения, но зато не будет дублирования.

- При разрыве соединения сообщение точно потеряется.

#### Exactly once

Сообщение доставлено один раз и прочитано один раз

- Самый распространенный сценарий

- Работает медленно

### Как реализовать Exactly once:

- Включение режима идемпотентности гарантирует, что если было отправлено сообщение несколько раз,
то в кафке останется 1 экземпляр этого сообщения. \
На стороне продюсера - `enable.idempotence`.
Каждому сообщению ставится номер транзакции и кафка при пересылке сообщений проверяет номера транзакций,
если от продюсера пришло сообщение с уникальным номером несколько раз - брокер его запишет 1 раз.
Потеря производительность от 5 до 20%

- `acks`=all

### Идемпотентность вручную

На стороне продюсера каждому сообщению присваивается уникальный номер.
Консьюмеры могут хранить номера сообщений, которые прочитали, в бд.
При чтении сообщений, консьюмер проверяет в бд, не читал ли он уже это сообщение и если читал -
помечает прочитанным.
Можно в качестве ключей использовать оффсеты сообщений, но такой подход не гарантирует идемпотентность 
при дублировании одного сообщения(только при повторной попытке прочитать сообщение с уже прочитанным оффсетом),
но для этого можно добавить `enable.idempotence` на продюсере для очень жесткой идемпотентности.

### Kafka Streams

Это библиотека для обработки потоков данных в реальном времени, построенная поверх Apache Kafka.

Имеет транзакции на уровне батчей(либо все сообщения батча читаются, либо весь батч считается непрочитанным)