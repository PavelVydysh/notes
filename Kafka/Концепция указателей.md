# Kafka

## Концепция указателей

- Кафка смаостоятельно может **менять лидеров**

- Для избежания потери сообщений:

  - `ack=all` - определяет, сколько реплик должны подтвердить получение сообщения, прежде чем оно будет считаться доставленным(на стороне продюссера).

    - `0` - не ждет пождтверждения
    - `1` - ждет подтверждения от лидера
    - `all` - ждет подтверждения от всех реплик

  - `min.insync.replicas` - минимальное кол-во синхронизированных реплик, которые должны подтвердить запись(на стороне брокера)

    При отправке сообщения, продюссер указывает, от скольких партиций он ожидает подтверждение

    Рекомендуется использовать `acks` совместно с `min.insync.replicas` и устанавливать `min.insync.replicas` хотя бы на 1 меньше чем количество реплик(`default.replication.factor`)

  - `unclean.leader.election.enabnled=true/false` - разрешено ли выбирать несинхронизированную реплику в качестве нового лидера в случае сбоя текущего лидера. При true, kafka может выбирать в качестве лидера реплику, не синхронизированную с последним лидером(на стороне брокера)

  - Реплики делятся на in-sync и not in-sync, если реплика содержит все последние записи, подтвержденные лидерм - она in-sync. Реплики, которые отстают от лидера и не содержат всех последних записей - not in-sync.

  - Кафка хранит данные в формате логов. Структура лога:

    - Номер записи(offset), уникален в рамках партиции
    - Время записи сообщения(время доабвления сообщения)
    - Ключ сообщения(на основании ключа выбирается партиция, куда запишется сообщение)
    - Данные сообщения

    Данные в kafka пишутся сегмантами(батчами). То есть при отправке данных через продюсер, он не отправляется данные моментально, он ждет определенное время/размер пакета и после этого отправляет данные одним пакетом.То есть, как только набрали определнный размер пакета(в килобайтах) - сообщение отправляется, иначе - дожидается определенного времени, которое должно пройти с момента попадания первого сообщения в пакет, после чего - отправляется. Чтение так же происходит пакетами.

    - `batch.size` - размер пакета(в байтах), после которого должна выполняться отправка(на стороне продюсера)
    - `linger.ms` - время формировани пакета(с момента попадания в него первого сообщения), после которого происходит отправка, если не был достигнут максимальный размер пакета(на стороне продюсера)

  - Каждое сообщение можно уникально идентифицировать по набору: Топика + номер партиции + смещение в партиции

  - Поддерживается хранение смещений, как на стороне kafka, так и на стороне клиента(например для того, чтобы прочитать старые сообщения)

  - Kafka хранит данные в файлах и удялет данные файлами. Решение об удалении принимается следующим образом: при создании файла, указываются даты создания самого раннего сообщения и самого позднего, файл удаляется, если в топике все сообщения были созданы раньше, чем n время назад, либо при достижении определенного размера.

    - `retention.bytes` - размер лога в байтах, по достижении которого лог удаляется(на стороне брокера)
    - `retention.ms` - время, через которое лог удаляется(на стороне брокера)

    Есть возможность отключения удаления сообщений.

  - Kafka хранит данные на диске в том же формате, в котором поулчает их и отправляет(процессор не задействуется в этом процессе)

  - Смещение в  партиции(offset) хранится для каждой consumer-группы отдельно