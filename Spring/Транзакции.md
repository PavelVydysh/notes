# Транзакции

Транзакция - набор операций, которые либо выполняются успешно все вместе,
либо не выполняются вообще.

Транзакции в Spring работают на аспектах.

Чтобы сообщить Spring, что метод должен выполняться в транзакции - нужно пометить метод
аннотацией @Transactional.

```java
class Repository {
    
    @Transactional
    public void save() {
        ...
    }
    
}
```

Для класса Repository будет создан прокси, который будет перехватывать вызовы save.

Если в методе save возникнет исключение - прокси отловит ее и откатит транзакцию, если
все завершится успешно - прокси закоммитит транзакцию.

Важно, что исключение, обработанное самим методом(try/catch или throws) не будет отслеживаться
прокси.

@Transactional можно повесить на класс, в таком случае транзакция будет применяться для
каждого метода метода класса. Если аннотация висит и на классе и на методе, то
у метода приоритет выше.

Атрибуты @Transactional:

- propagation - Как вести себя при уже существующей транзакции

- isolation - Уровень изоляции транзакции
- readOnly - Оптимизация для запросов только на чтение
- rollbackFor - Явное указание, при каких исключениях делать rollback
- noRollbackFor - Указать, какие исключения НЕ приводят к rollback
- timeout - Максимальное время выполнения транзакции

```java
@Transactional(
    propagation = Propagation.REQUIRES_NEW,
    isolation = Isolation.SERIALIZABLE,
    timeout = 30,
    rollbackFor = {IOException.class}
)
public void saveData() {
    ... 
}
```

Уровни распространения транзакций(или вести себя транзакции относительно других транзакций)

- REQUIRED - (по умолчанию) Использует текущую транзакцию, если есть. Иначе создаёт новую.

- REQUIRES_NEW - Всегда создает новую транзакцию, приостанавливая текущую.

- NESTED - Создает вложенную транзакцию, которая может быть откатана отдельно.

- SUPPORTS - Использует текущую транзакцию, если есть. Иначе работает без неё.

- NOT_SUPPORTED - Выполняется вне транзакции. Приостанавливает текущую, если она есть.

- MANDATORY - Требует существующую транзакцию, иначе — исключение.

- NEVER - Запрещает наличие транзакции. Если есть — исключение.

Уровни изоляции транзакции:

- READ_UNCOMMITTED - Видит даже незакоммиченные данные

- READ_COMMITTED - Видит только закоммиченные данные (по умолчанию в PostgreSQL)

- REPEATABLE_READ - Повторное чтение вернёт те же данные

- SERIALIZABLE - Полная изоляция — как если бы транзакции выполнялись последовательно

- DEFAULT - Уровень по умолчанию в БД

Допускается ставить @Transactional, как в сервисе, так и в репозитории.
Ни то, ни другое не противоречит чистой архитектуре.