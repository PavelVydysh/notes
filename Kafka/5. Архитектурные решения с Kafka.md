# Kafka

## Архитектурные решения с использованием Kafka

### Kafka как лог событий

Service -> Kafka -> Сервис по сбору и обработке логов

### Репликация данных из одного места в другое

Источник данных(Postgres) -> Kafka -> Сервис конвертации данных -> Kafka -> Источник данных(MongoDB)

### Подписка на сообщения

Использование кафки в роли очереди событий.

Сервис -> Kafka -> Сервис(1, 2, 3)

Не нужно плодить кучу топиков(не создавать топик на каждое событие).

Лучший подход: 1 топик на сущность, каждый консьюмер сам выбирает какие события, связанные с сущностью
он будет обрабатывать(тип события можно передавать в заголовке или в теле сообщения, зависит от контракта).

### Обеспечение консистентности

Фронт -> (сообщение о необходимости создать пользователя) Фасад -> Kafka -> Фасад  -> [Сервис пользователей], [Сервис корзины товаров]

То есть идет попытка создания пользователя, фасад принимает сообщение и кладет его в кафку, через время сам же его вычитывает
и идет в нужные микросервисы передавать это сообщение. \
Если упал сервис корзины, то через время сообщение повторно прочитается, так как не будет помечено, как прочитанное. \
При такой реализации важно соблюдение идемпотентности.

Eventually-consistency:
- У разных сервисов может быть разное состояние(в сервисе пользователей пользак создался, а в сервисе корзин - нет)
- При восстановлении нормального функционирования системы, сервисы придут к одному и тому же состоянию
- Состояние неконсистентности возможно только когда приходить событие на запись
- Состояние поддерживается системой
- Действия могут быть как применены, так и отменены(например если не смогли создать пользователя, но смогли создать корзину
то нужно отменить создание корзины)

Для повышения скорости обработки сообщений(тк запрещено заходить в консьюмер больше, чем 1 потоком),
Можно засовывать задачи в executor. В этом случае важно следить за соблюдением порядка сообщений. Во первых передачей ключа, 
во вторых сортировать сообщения для одной сущности перед экзекьютором и передать в экзекьютор последовательный список сообщений.
